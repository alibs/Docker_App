global
    log stdout format raw local0
    maxconn 2048

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    default-server check inter 3s fall 3 rise 2

# Use Docker's DNS (127.0.0.11), auto-loaded via resolv.conf
resolvers docker
    parse-resolv-conf
    hold valid 10s

frontend fe_http
    bind *:8080
    mode http
    acl is_game path_beg -i /game
    use_backend be_game if is_game
    default_backend be_nginx

backend be_nginx
    balance roundrobin
    option httpchk GET /
    server s1 nginx1:80 check
    server s2 nginx2:80 check

backend be_game
    option httpchk GET /
    http-request set-path %[path,regsub(^/game,/,)]
    # resolve via Docker DNS; don't fail if name missing at boot
    server typinggame typinggame:80 check resolvers docker resolve-prefer ipv4 init-addr none
